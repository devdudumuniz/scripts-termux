#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
DMTech Termux Pentest - Interface TUI Principal
Interface de usu√°rio em modo texto com Rich
"""

import os
import sys
import json
import argparse
import time
from pathlib import Path
from datetime import datetime

# Adicionar diret√≥rio raiz ao path
sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from rich.console import Console
    from rich.panel import Panel
    from rich.table import Table
    from rich.layout import Layout
    from rich.live import Live
    from rich.progress import Progress, SpinnerColumn, BarColumn, TextColumn
    from rich.prompt import Prompt, Confirm
    from rich.text import Text
    from rich.align import Align
    from rich import box
except ImportError:
    print("[!] Biblioteca 'rich' n√£o instalada")
    print("[!] Execute: pip install rich")
    sys.exit(1)

from core.modules_loader import get_loader
from core.utils_logging import get_logger
from core.utils_export import get_exporter

class PentestTUI:
    """Interface TUI principal do framework"""
    
    def __init__(self, mode='hybrid'):
        self.mode = mode
        self.console = Console()
        self.loader = get_loader()
        self.logger = get_logger()
        self.exporter = get_exporter()
        
        # Carregar configura√ß√µes
        self.config = self._load_config()
        self.theme = self._load_theme()
        
        # Carregar m√≥dulos
        self.modules = self.loader.load_all_modules()
        
    def _load_config(self):
        """Carrega configura√ß√µes"""
        config_path = Path('config/settings.json')
        try:
            with open(config_path, 'r') as f:
                return json.load(f)
        except:
            return {}
    
    def _load_theme(self):
        """Carrega tema atual"""
        theme_path = Path('config/themes.json')
        try:
            with open(theme_path, 'r') as f:
                themes = json.load(f)
                current = themes.get('current_theme', 'dark')
                return themes.get(current, themes['dark'])
        except:
            return {
                'primary': '#00ff00',
                'secondary': '#00ccff',
                'background': '#000000'
            }
    
    def show_banner(self):
        """Exibe banner principal"""
        self.console.clear()
        
        banner_text = """
    ____  __  ________           __       ______                           
   / __ \/  |/  /_  __/__  _____/ /_     /_  __/__  _________ ___  ___  __
  / / / / /|_/ / / / / _ \/ ___/ __ \     / / / _ \/ ___/ __ `__ \/ / / / /
 / /_/ / /  / / / / /  __/ /__/ / / /    / / /  __/ /  / / / / / / /_/ /  
/_____/_/  /_/ /_/  \___/\___/_/ /_/    /_/  \___/_/  /_/ /_/ /_/\__,_/   
                                                                            
    ____             __            __     ______                            
   / __ \___  ____  / /____  _____/ /_   / ____/________ _____ ___  ___ 
  / /_/ / _ \/ __ \/ __/ _ \/ ___/ __/  / /_  / ___/ __ `/ __ `__ \/ _ \\
 / ____/  __/ / / / /_/  __(__  ) /_   / __/ / /  / /_/ / / / / / /  __/
/_/    \___/_/ /_/\__/\___/____/\__/  /_/   /_/   \__,_/_/ /_/ /_/\___/ 
        """
        
        banner_panel = Panel(
            Align.center(Text(banner_text, style=self.theme['primary'])),
            title="[bold]DMTech Pentest Framework v1.0.0[/bold]",
            subtitle=f"[italic]Modo: {self.mode.upper()}[/italic]",
            border_style=self.theme['secondary'],
            box=box.DOUBLE
        )
        
        self.console.print(banner_panel)
        self.console.print()
    
    def show_main_menu(self):
        """Exibe menu principal"""
        table = Table(
            title="[bold]Menu Principal[/bold]",
            show_header=True,
            header_style=f"bold {self.theme['primary']}",
            border_style=self.theme['secondary'],
            box=box.ROUNDED
        )
        
        table.add_column("ID", style="cyan", justify="center", width=6)
        table.add_column("M√≥dulo", style="green", width=20)
        table.add_column("Descri√ß√£o", style="white", width=50)
        
        # M√≥dulos de plugins
        menu_items = [
            ("1", "OSINT", "Coleta de informa√ß√µes p√∫blicas"),
            ("2", "WEB", "Testes de aplica√ß√µes web"),
            ("3", "REDE", "An√°lise e scanning de rede"),
            ("4", "EXPLOIT", "Ferramentas de explora√ß√£o"),
            ("5", "FORENSIC", "An√°lise forense digital"),
            ("6", "AUTOMATION", "Automa√ß√£o de tarefas"),
            ("", "", ""),
            ("7", "ROOT-TOOLS", "Ferramentas que requerem ROOT"),
            ("8", "NO-ROOT-TOOLS", "Ferramentas sem ROOT"),
            ("", "", ""),
            ("9", "LOGS & EXPORT", "Visualizar logs e exporta√ß√µes"),
            ("10", "CONFIGURA√á√ïES", "Ajustes do framework"),
            ("", "", ""),
            ("0", "SAIR", "Encerrar o framework")
        ]
        
        for item_id, name, desc in menu_items:
            if item_id:
                table.add_row(item_id, name, desc)
            else:
                table.add_row("", "", "")
        
        self.console.print(table)
        self.console.print()
    
    def run_module_menu(self, module_name):
        """Executa menu de um m√≥dulo espec√≠fico"""
        self.console.clear()
        self.show_banner()
        
        # Obter m√≥dulo
        module = self.loader.get_module(module_name)
        
        if not module:
            self.console.print(f"[red]M√≥dulo {module_name} n√£o encontrado![/red]")
            input("\nPressione Enter para continuar...")
            return
        
        # Obter metadados
        metadata = self.loader.get_module_metadata(module_name)
        
        if metadata:
            panel = Panel(
                f"[bold]{metadata.get('description', 'Sem descri√ß√£o')}[/bold]",
                title=f"[green]{metadata.get('name', module_name)}[/green]",
                border_style="cyan"
            )
            self.console.print(panel)
            self.console.print()
        
        # Executar m√≥dulo
        try:
            self.loader.run_module(module_name, context=self)
        except Exception as e:
            self.console.print(f"[red]Erro ao executar m√≥dulo: {e}[/red]")
            self.logger.error(f"Erro no m√≥dulo {module_name}: {e}")
        
        input("\nPressione Enter para voltar ao menu principal...")
    
    def show_logs(self):
        """Exibe logs recentes"""
        self.console.clear()
        self.show_banner()
        
        self.console.print(Panel("[bold]Logs Recentes[/bold]", border_style="cyan"))
        self.console.print()
        
        logs = self.logger.get_recent_logs(20)
        
        if not logs:
            self.console.print("[yellow]Nenhum log encontrado[/yellow]")
        else:
            table = Table(show_header=True, header_style="bold cyan")
            table.add_column("Timestamp", width=20)
            table.add_column("Ferramenta", width=25)
            table.add_column("Status", width=10)
            
            for log in logs:
                status_color = "green" if log.get('status') == 'success' else "red"
                table.add_row(
                    log.get('timestamp', 'N/A')[:19],
                    log.get('tool', 'N/A'),
                    f"[{status_color}]{log.get('status', 'N/A')}[/{status_color}]"
                )
            
            self.console.print(table)
        
        input("\nPressione Enter para voltar...")
    
    def show_exports(self):
        """Exibe exporta√ß√µes dispon√≠veis"""
        self.console.clear()
        self.show_banner()
        
        self.console.print(Panel("[bold]Arquivos Exportados[/bold]", border_style="cyan"))
        self.console.print()
        
        exports = self.exporter.list_exports('all')
        
        if not exports:
            self.console.print("[yellow]Nenhuma exporta√ß√£o encontrada[/yellow]")
        else:
            self.console.print(f"[green]Total de arquivos: {len(exports)}[/green]\n")
            
            for i, export_file in enumerate(exports[:20], 1):
                file_path = Path(export_file)
                size = file_path.stat().st_size
                modified = datetime.fromtimestamp(file_path.stat().st_mtime)
                
                self.console.print(
                    f"[cyan]{i:2d}.[/cyan] {file_path.name} "
                    f"[dim]({size} bytes - {modified.strftime('%Y-%m-%d %H:%M')})[/dim]"
                )
        
        input("\nPressione Enter para voltar...")
    
    def show_settings(self):
        """Exibe e permite editar configura√ß√µes"""
        self.console.clear()
        self.show_banner()
        
        self.console.print(Panel("[bold]Configura√ß√µes[/bold]", border_style="cyan"))
        self.console.print()
        
        # Exibir configura√ß√µes atuais
        table = Table(show_header=True, header_style="bold cyan")
        table.add_column("Configura√ß√£o", width=30)
        table.add_column("Valor Atual", width=30)
        
        table.add_row("Modo", self.mode)
        table.add_row("Max Threads", str(self.config.get('performance', {}).get('max_threads', 10)))
        table.add_row("Tema", self.config.get('current_theme', 'dark'))
        table.add_row("Logging", "Habilitado" if self.config.get('logging', {}).get('enabled', True) else "Desabilitado")
        
        self.console.print(table)
        self.console.print()
        
        self.console.print("[yellow]1.[/yellow] Alterar tema (dark/light)")
        self.console.print("[yellow]2.[/yellow] Ajustar threads")
        self.console.print("[yellow]0.[/yellow] Voltar")
        
        choice = Prompt.ask("\nEscolha uma op√ß√£o", default="0")
        
        if choice == "1":
            self.toggle_theme()
        elif choice == "2":
            self.adjust_threads()
    
    def toggle_theme(self):
        """Alterna entre tema dark e light"""
        theme_path = Path('config/themes.json')
        
        try:
            with open(theme_path, 'r') as f:
                themes = json.load(f)
            
            current = themes.get('current_theme', 'dark')
            new_theme = 'light' if current == 'dark' else 'dark'
            
            themes['current_theme'] = new_theme
            
            with open(theme_path, 'w') as f:
                json.dump(themes, f, indent=2)
            
            self.theme = themes[new_theme]
            self.console.print(f"\n[green]Tema alterado para: {new_theme}[/green]")
            
        except Exception as e:
            self.console.print(f"[red]Erro ao alterar tema: {e}[/red]")
        
        time.sleep(1)
    
    def adjust_threads(self):
        """Ajusta n√∫mero de threads"""
        current = self.config.get('performance', {}).get('max_threads', 10)
        
        new_threads = Prompt.ask(
            f"\nN√∫mero de threads (atual: {current})",
            default=str(current)
        )
        
        try:
            threads = int(new_threads)
            if 1 <= threads <= 100:
                self.config['performance']['max_threads'] = threads
                
                # Salvar
                with open('config/settings.json', 'w') as f:
                    json.dump(self.config, f, indent=2)
                
                self.console.print(f"[green]Threads ajustadas para: {threads}[/green]")
            else:
                self.console.print("[red]Valor deve estar entre 1 e 100[/red]")
        except:
            self.console.print("[red]Valor inv√°lido[/red]")
        
        time.sleep(1)
    
    def show_loading(self, message="Carregando..."):
        """Exibe anima√ß√£o de loading"""
        with Progress(
            SpinnerColumn(),
            TextColumn("[progress.description]{task.description}"),
            console=self.console
        ) as progress:
            task = progress.add_task(message, total=None)
            time.sleep(2)
    
    def run(self):
        """Loop principal da TUI"""
        while True:
            self.console.clear()
            self.show_banner()
            self.show_main_menu()
            
            choice = Prompt.ask("[bold cyan]Escolha uma op√ß√£o[/bold cyan]", default="0")
            
            if choice == "1":
                self.run_module_menu('osint')
            elif choice == "2":
                self.run_module_menu('web')
            elif choice == "3":
                self.run_module_menu('rede')
            elif choice == "4":
                self.run_module_menu('exploit')
            elif choice == "5":
                self.run_module_menu('forensic')
            elif choice == "6":
                self.run_module_menu('automation')
            elif choice == "7":
                self.console.print("\n[yellow]ROOT-TOOLS: Execute scripts em root-tools/ diretamente[/yellow]")
                input("\nPressione Enter para continuar...")
            elif choice == "8":
                self.console.print("\n[yellow]NO-ROOT-TOOLS: Execute scripts em no-root-tools/ diretamente[/yellow]")
                input("\nPressione Enter para continuar...")
            elif choice == "9":
                self.show_logs()
                self.show_exports()
            elif choice == "10":
                self.show_settings()
            elif choice == "0":
                if Confirm.ask("\n[yellow]Deseja realmente sair?[/yellow]"):
                    self.console.print("\n[green]At√© logo! üëã[/green]\n")
                    break
            else:
                self.console.print("[red]Op√ß√£o inv√°lida![/red]")
                time.sleep(1)

def main():
    """Fun√ß√£o principal"""
    parser = argparse.ArgumentParser(description='DMTech Termux Pentest Framework')
    parser.add_argument('--mode', choices=['root', 'no-root', 'hybrid'], 
                       default='hybrid', help='Modo de opera√ß√£o')
    
    args = parser.parse_args()
    
    try:
        tui = PentestTUI(mode=args.mode)
        tui.run()
    except KeyboardInterrupt:
        print("\n\n[!] Interrompido pelo usu√°rio\n")
    except Exception as e:
        print(f"\n[!] Erro fatal: {e}\n")
        import traceback
        traceback.print_exc()

if __name__ == '__main__':
    main()
