#!/data/data/com.termux/files/usr/bin/bash
# -*- coding: utf-8 -*-
#
# Ping Sweep - Varredura de rede sem privilégios ROOT
# Descobre hosts ativos usando ping simples
#
# PRÉ-REQUISITOS:
#   - Nenhum (funciona sem root)
#
# USO:
#   ./ping_sweep.sh [network_cidr]
#   Exemplo: ./ping_sweep.sh 192.168.1.0/24
#

set -e

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Configurações
NETWORK="${1:-192.168.1.0/24}"
OUTPUT_DIR="../output"
LOG_DIR="../logs"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
THREADS=20

# Criar diretórios
mkdir -p "$OUTPUT_DIR/json" "$OUTPUT_DIR/csv" "$LOG_DIR"

# Arquivo de log
LOGFILE="$LOG_DIR/ping_sweep_${TIMESTAMP}.log"

# Função de log
log() {
    echo -e "${CYAN}[$(date +'%H:%M:%S')]${NC} $1" | tee -a "$LOGFILE"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1" | tee -a "$LOGFILE"
}

log_success() {
    echo -e "${GREEN}[✓]${NC} $1" | tee -a "$LOGFILE"
}

# Expandir CIDR para lista de IPs
expand_cidr() {
    python3 << EOF
import ipaddress
network = ipaddress.ip_network('$NETWORK', strict=False)
for ip in network.hosts():
    print(ip)
EOF
}

# Ping sweep com Python (multithreading)
ping_sweep() {
    log "Executando ping sweep em $NETWORK..."
    
    python3 << 'PYEOF'
import subprocess
import json
import csv
from datetime import datetime
from concurrent.futures import ThreadPoolExecutor, as_completed
import sys

NETWORK = "$NETWORK"
THREADS = $THREADS
OUTPUT_DIR = "$OUTPUT_DIR"
TIMESTAMP = "$TIMESTAMP"

def ping_host(ip):
    """Pinga um host e retorna resultado"""
    try:
        result = subprocess.run(
            ['ping', '-c', '1', '-W', '1', str(ip)],
            capture_output=True,
            timeout=2
        )
        
        if result.returncode == 0:
            # Extrair tempo de resposta
            output = result.stdout.decode('utf-8', errors='ignore')
            time_match = None
            for line in output.split('\n'):
                if 'time=' in line:
                    import re
                    match = re.search(r'time=(\S+)', line)
                    if match:
                        time_match = match.group(1)
                        break
            
            return {
                'ip': str(ip),
                'status': 'up',
                'reachable': True,
                'response_time': time_match if time_match else 'N/A',
                'timestamp': datetime.now().isoformat()
            }
        else:
            return None
    except Exception as e:
        return None

# Expandir CIDR
import ipaddress
network = ipaddress.ip_network(NETWORK, strict=False)
ip_list = [str(ip) for ip in network.hosts()]

print(f"Escaneando {len(ip_list)} hosts...")

active_hosts = []
completed = 0

with ThreadPoolExecutor(max_workers=THREADS) as executor:
    futures = {executor.submit(ping_host, ip): ip for ip in ip_list}
    
    for future in as_completed(futures):
        completed += 1
        result = future.result()
        
        if result:
            active_hosts.append(result)
            print(f"[{completed}/{len(ip_list)}] {result['ip']} - UP ({result['response_time']})")
        else:
            if completed % 10 == 0:
                print(f"[{completed}/{len(ip_list)}] Progresso...")

# Salvar JSON
json_output = f"{OUTPUT_DIR}/json/ping_sweep_{TIMESTAMP}.json"
with open(json_output, 'w', encoding='utf-8') as f:
    json.dump({
        'scan_timestamp': datetime.now().isoformat(),
        'network': NETWORK,
        'total_scanned': len(ip_list),
        'total_active': len(active_hosts),
        'hosts': active_hosts
    }, f, indent=2, ensure_ascii=False)

# Salvar CSV
csv_output = f"{OUTPUT_DIR}/csv/ping_sweep_{TIMESTAMP}.csv"
if active_hosts:
    with open(csv_output, 'w', newline='', encoding='utf-8') as f:
        writer = csv.DictWriter(f, fieldnames=active_hosts[0].keys())
        writer.writeheader()
        writer.writerows(active_hosts)

print(f"\nEncontrados {len(active_hosts)} hosts ativos de {len(ip_list)} escaneados")
print(f"JSON: {json_output}")
print(f"CSV: {csv_output}")
PYEOF
    
    log_success "Ping sweep concluído"
}

# Main
main() {
    echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo -e "${YELLOW}  Ping Sweep - DMTech Pentest${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════${NC}"
    echo ""
    
    log "Alvo: $NETWORK"
    log "Threads: $THREADS"
    
    ping_sweep
    
    echo ""
    log_success "Scan concluído com sucesso!"
}

main
