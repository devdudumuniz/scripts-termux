#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Plugin AUTOMATION - Task Automation
Módulo de automação de tarefas de pentest
"""

import sys
import json
from pathlib import Path
from datetime import datetime

sys.path.insert(0, str(Path(__file__).parent.parent.parent / 'core'))

from utils_logging import get_logger
from utils_export import get_exporter

def get_module_metadata():
    """Retorna metadados do módulo"""
    return {
        'name': 'AUTOMATION',
        'category': 'AUTOMATION',
        'description': 'Automação de tarefas e workflows de pentest',
        'version': '1.0.0',
        'author': 'DMTech',
        'tools': [
            'Workflow Builder',
            'Scheduled Tasks',
            'Report Generator'
        ]
    }

def run_module(tui_context=None):
    """Executa o módulo AUTOMATION"""
    logger = get_logger()
    logger.info("Módulo AUTOMATION iniciado")
    
    print("\n" + "="*60)
    print("  AUTOMATION Module - DMTech Pentest")
    print("="*60 + "\n")
    
    print("Ferramentas disponíveis:")
    print("  1) Workflow Builder")
    print("  2) Scheduled Tasks")
    print("  3) Report Generator")
    print("  0) Voltar")
    
    choice = input("\nEscolha uma opção: ").strip()
    
    if choice == '1':
        workflow_builder()
    elif choice == '2':
        scheduled_tasks()
    elif choice == '3':
        report_generator()
    elif choice == '0':
        return
    else:
        print("Opção inválida!")
    
    return {'status': 'success'}

def workflow_builder():
    """Construtor de workflows"""
    print("\n[*] Workflow Builder")
    print("[!] Crie sequências automatizadas de testes\n")
    
    print("Exemplo de workflow:")
    print("  1. Ping Sweep na rede")
    print("  2. Port Scan em hosts ativos")
    print("  3. Web Enumeration em servidores web")
    print("  4. Gerar relatório consolidado")
    
    print("\n[!] Funcionalidade em desenvolvimento")
    print("[!] Use scripts bash para criar workflows personalizados")

def scheduled_tasks():
    """Tarefas agendadas"""
    print("\n[*] Scheduled Tasks")
    print("[!] Agende scans para execução automática\n")
    
    print("Exemplo:")
    print("  - Scan diário da rede às 02:00")
    print("  - Verificação de câmeras a cada 6 horas")
    print("  - Backup de logs semanalmente")
    
    print("\n[!] Funcionalidade em desenvolvimento")
    print("[!] Use cron para agendar tarefas no Termux")

def report_generator():
    """Gerador de relatórios"""
    print("\n[*] Report Generator")
    print("[!] Gera relatórios consolidados dos scans\n")
    
    logger = get_logger()
    exporter = get_exporter()
    
    # Listar exports disponíveis
    json_files = exporter.list_exports('json')
    
    if not json_files:
        print("[!] Nenhum resultado encontrado para gerar relatório")
        return
    
    print(f"[+] Encontrados {len(json_files)} arquivos de resultados")
    print("\nGerando relatório consolidado...")
    
    # Consolidar dados
    consolidated = {
        'report_timestamp': datetime.now().isoformat(),
        'total_scans': len(json_files),
        'scans': []
    }
    
    for json_file in json_files[:10]:  # Limitar a 10 mais recentes
        try:
            with open(json_file, 'r') as f:
                data = json.load(f)
                consolidated['scans'].append({
                    'file': Path(json_file).name,
                    'timestamp': data.get('scan_timestamp', 'Unknown'),
                    'type': Path(json_file).stem.split('_')[0]
                })
        except:
            pass
    
    # Exportar relatório
    report_file = exporter.export_json(consolidated, 'consolidated_report')
    
    print(f"\n[+] Relatório gerado: {report_file}")
    print(f"[+] Total de scans incluídos: {len(consolidated['scans'])}")
    
    logger.log_execution('Report Generator', {}, 
                        results={'scans_included': len(consolidated['scans'])}, 
                        status='success')

if __name__ == '__main__':
    run_module()
